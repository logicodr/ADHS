<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#556B2F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>ADHS Jetzt-Planer</title>
    <style>
        /* CSS styles remain the same */
        :root {
            --olive-dark: #556B2F;
            --olive-medium: #6B8E23;
            --olive-light: #9ACD32;
            --olive-pale: #E8F0D8;
            --cream: #FFFAF0;
            --terracotta: #CD5C5C;
            --bg-color: #F8F9F5;
            --text-color: #33402C;
            --success-color: #3A5F0B;
            --warning-color: #B59410;
        }
        
        /* Rest of CSS styles... */
        /* I'm keeping this comment brief to focus on the JavaScript issue */
    </style>
    <!-- Register service worker in a separate script tag -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- HTML Structure remains the same -->
        <div class="header">
            <h1>ADHS Jetzt-Planer</h1>
            <div class="current-time" id="current-time">12:30</div>
        </div>
        
        <!-- Rest of HTML structure... -->
        <!-- I'm keeping this comment brief to focus on the JavaScript issue -->
    </div>
    
    <!-- Audio Element für den Alarm -->
    <audio id="alarm-sound">
        <source src="uplifting-intro-music-for-youtube-and-podcasts-by-joshua-wales-292600.mp3" type="audio/mpeg">
        Dein Browser unterstützt das Audio-Element nicht.
    </audio>

    <!-- Place ALL JavaScript in a SINGLE script tag at the end of the body -->
    <script>
        // State management
        let state = {
            activities: [],
            departureTime: '14:30',
            alarm: {
                enabled: true,
                time: 15 // minutes before departure
            },
            taskTimer: null,
            currentTaskIndex: -1
        };
        
        // DOM Elements
        const currentTimeEl = document.getElementById('current-time');
        const countdownEl = document.getElementById('countdown');
        const taskCountdownEl = document.getElementById('task-countdown');
        const availableTimeEl = document.getElementById('available-time');
        const plannedTimeEl = document.getElementById('planned-time');
        const bufferTimeEl = document.getElementById('buffer-time');
        const activityListEl = document.getElementById('activity-list');
        const addFormEl = document.getElementById('add-form');
        const activityNameEl = document.getElementById('activity-name');
        const activityDurationEl = document.getElementById('activity-duration');
        const departureTimeEl = document.getElementById('departure-time');
        const alarmToggleEl = document.getElementById('alarm-toggle');
        const alarmOptionsEl = document.getElementById('alarm-options');
        const alarmTimeEl = document.getElementById('alarm-time');
        const alarmSoundEl = document.getElementById('alarm-sound');
        const notificationEl = document.getElementById('notification');
        
        // Alarm variables
        let alarmTimeout = null;
        let notificationTimeout = null;
        let taskCountdownInterval = null;
        
        // Variables for lock screen notifications
        let notificationTimer = null;
        let taskNotification = null;
        
        // Delete All Activities function
        function deleteAllActivities() {
            // Confirm before deleting all
            if (confirm('Möchtest du wirklich alle Aktivitäten löschen?')) {
                // Clear the activities array
                state.activities = [];
                
                // Reset current task index and clear timers
                state.currentTaskIndex = -1;
                
                // Clear any running task timer
                if (taskCountdownInterval) {
                    clearInterval(taskCountdownInterval);
                    taskCountdownInterval = null;
                }
                
                // Hide task countdown
                taskCountdownEl.style.display = 'none';
                
                // Update UI
                renderActivities();
                updateTimeSummary();
                saveState();
                
                // Clear notifications
                if (taskNotification && taskNotification.close) {
                    taskNotification.close();
                }
                
                // Show confirmation
                showNotification('Alle Aktivitäten wurden gelöscht', 3000);
            }
        }
        
        // Create a persistent notification that shows current task
        function createPersistentNotification(activity, remainingMinutes, remainingSeconds, finishTimeStr) {
            // Only proceed if notification permission is granted
            if (!("Notification" in window) || Notification.permission !== "granted") {
                return;
            }

            try {
                // Format time remaining nicely
                const timeDisplay = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                
                // Use different notification options based on platform
                const options = {
                    body: `${activity.name}: noch ${timeDisplay} Min (bis ${finishTimeStr})`,
                    icon: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiM2QjhFMjMiIHJ4PSIxMCIgcnk9IjEwIi8+PHRleHQgeD0iNTAiIHk9IjYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNDAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn5ONPC90ZXh0Pjwvc3ZnPg==",
                    tag: 'adhs-task-notification', // This ensures we update existing notification instead of creating new ones
                    renotify: true, // This makes the notification alert the user again even with the same tag
                    silent: true, // Don't play sound for these updates
                    // Add timestamp to make notification more visible on some platforms
                    timestamp: Date.now()
                };

                // Create/update the notification
                if (taskNotification) {
                    // Some browsers support updating existing notifications
                    if (taskNotification.close) {
                        taskNotification.close();
                    }
                }
                
                taskNotification = new Notification("ADHS Planer", options);
            } catch (e) {
                console.error("Error creating notification:", e);
            }
        }

        // Update task notification
        function updateTaskNotification() {
            try {
                // Only create notification if task countdown is visible
                if (taskCountdownEl.style.display !== 'none' && state.currentTaskIndex !== -1) {
                    const activity = state.activities[state.currentTaskIndex];
                    if (!activity || activity.completed) return;

                    const now = new Date();
                    // Ensure endTime is a Date object
                    const endTime = activity.endTime instanceof Date ? 
                        activity.endTime : new Date(activity.endTime);
                    
                    const remainingMs = endTime - now;
                    
                    if (remainingMs <= 0) return;
                    
                    const remainingMinutes = Math.floor(remainingMs / 60000);
                    const remainingSeconds = Math.floor((remainingMs % 60000) / 1000);
                    const finishTimeStr = `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                    
                    createPersistentNotification(activity, remainingMinutes, remainingSeconds, finishTimeStr);
                }
            } catch (e) {
                console.error("Error updating notification:", e);
            }
        }

        function startNotificationTimer() {
            try {
                if (notificationTimer) {
                    clearInterval(notificationTimer);
                }
                
                // Update notification every 15 seconds
                notificationTimer = setInterval(updateTaskNotification, 15000);
                
                // Also update immediately
                updateTaskNotification();
            } catch (e) {
                console.error("Error starting notification timer:", e);
            }
        }

        function stopNotificationTimer() {
            try {
                if (notificationTimer) {
                    clearInterval(notificationTimer);
                    notificationTimer = null;
                }
                
                // Clear any existing notification
                if (taskNotification && taskNotification.close) {
                    taskNotification.close();
                }
            } catch (e) {
                console.error("Error stopping notification timer:", e);
            }
        }
        
        // Rest of the JavaScript functions...
        // For brevity, I'm not showing all functions, but they should be included here
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Request notification permission early
                if ("Notification" in window) {
                    if (Notification.permission === "granted") {
                        // Already have permission
                        startNotificationTimer();
                    } else if (Notification.permission !== "denied") {
                        // Request permission and start timer if granted
                        Notification.requestPermission().then(permission => {
                            if (permission === "granted") {
                                startNotificationTimer();
                            }
                        });
                    }
                }
                
                // Load saved state
                loadState();
                
                // Initialize UI
                departureTimeEl.value = state.departureTime;
                alarmToggleEl.checked = state.alarm.enabled;
                alarmTimeEl.value = state.alarm.time;
                
                // Show/hide alarm options based on toggle state
                if (state.alarm.enabled) {
                    alarmOptionsEl.classList.add('visible');
                } else {
                    alarmOptionsEl.classList.remove('visible');
                }
                
                // Find current task index if not set
                if (state.currentTaskIndex === -1) {
                    state.currentTaskIndex = state.activities.findIndex(a => !a.completed);
                }
                
                // Render activities
                renderActivities();
                
                // Set up update intervals
                updateTimeDisplay();
                updateTimeSummary();
                setInterval(updateTimeDisplay, 10000); // Update time every 10 seconds
                setInterval(updateTimeSummary, 30000); // Update summary every 30 seconds
                
                // Set up alarm if enabled
                scheduleAlarm();
                
                // Event listeners
                document.getElementById('show-add-form').addEventListener('click', function() {
                    addFormEl.style.display = 'block';
                    activityNameEl.focus();
                });
                
                document.getElementById('cancel-add').addEventListener('click', function() {
                    addFormEl.style.display = 'none';
                    activityNameEl.value = '';
                });
                
                document.getElementById('add-activity-btn').addEventListener('click', addActivity);
                document.getElementById('delete-all-btn').addEventListener('click', deleteAllActivities);
                document.getElementById('save-departure').addEventListener('click', saveSettings);
                
                alarmToggleEl.addEventListener('change', function() {
                    state.alarm.enabled = this.checked;
                    
                    if (this.checked) {
                        alarmOptionsEl.classList.add('visible');
                    } else {
                        alarmOptionsEl.classList.remove('visible');
                    }
                    
                    // Clear any existing alarms
                    if (alarmTimeout) {
                        clearTimeout(alarmTimeout);
                        alarmTimeout = null;
                    }
                    
                    // Schedule new alarm if enabled
                    if (state.alarm.enabled) {
                        scheduleAlarm();
                    }
                    
                    saveState();
                });
                
                document.getElementById('notification-toggle').addEventListener('change', function() {
                    if (this.checked) {
                        // Request permission if needed
                        if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                            Notification.requestPermission().then(permission => {
                                if (permission === "granted") {
                                    startNotificationTimer();
                                }
                            });
                        } else if ("Notification" in window && Notification.permission === "granted") {
                            startNotificationTimer();
                        }
                    } else {
                        stopNotificationTimer();
                    }
                });
                
                alarmTimeEl.addEventListener('change', function() {
                    state.alarm.time = parseInt(this.value);
                    
                    // Clear any existing alarms
                    if (alarmTimeout) {
                        clearTimeout(alarmTimeout);
                        alarmTimeout = null;
                    }
                    
                    // Schedule new alarm if enabled
                    if (state.alarm.enabled) {
                        scheduleAlarm();
                    }
                    
                    saveState();
                });
                
                document.getElementById('test-alarm').addEventListener('click', function() {
                    playAlarm();
                    showNotification('Alarm Test!', 3000);
                });
                
                // Add activity on Enter key in fields
                activityNameEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addActivity();
                    }
                });
                
                activityDurationEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addActivity();
                    }
                });
                
                // Listen for visibility change to handle when app comes back into focus
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden) {
                        // Page is hidden (in background or screen locked)
                        // Ensure notification is showing when screen locks
                        updateTaskNotification();
                    } else {
                        // Page is visible again
                        // Continue normal updates
                        updateTimeDisplay();
                        updateTimeSummary();
                        
                        // Check if we need to restart task countdown
                        if (!taskCountdownInterval && state.activities.some(a => !a.completed)) {
                            startTaskCountdown();
                        }
                    }
                });
                
                // Special handling for mobile devices
                if ('ontouchstart' in window) {
                    // Make buttons larger for touch
                    document.querySelectorAll('.activity-btn').forEach(btn => {
                        btn.style.minWidth = '36px';
                        btn.style.minHeight = '36px';
                    });
                    
                    // Enable vibration for notifications if available
                    try {
                        if ('vibrate' in navigator) {
                            navigator.vibrate(1); // Test vibration permission
                        }
                    } catch (e) {
                        console.log('Vibration not available');
                    }
                }
            } catch (e) {
                console.error("Error initializing app:", e);
                alert("Es gab ein Problem beim Starten der App. Bitte laden Sie die Seite neu.");
            }
        });
    </script>
</body>
</html>
