<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHS Jetzt-Planer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 50%, #e0e7ff 100%);
        }
        
        .current-task-border {
            border: 2px solid #3B82F6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="app">
        <!-- Loading... -->
    </div>

    <script>
        // Simple State
        let state = {
            currentTime: new Date(),
            activities: [],
            departureTime: '14:30',
            showAddForm: false,
            showSettings: false,
            alarmEnabled: true,
            alarmMinutes: 15,
            currentTaskIndex: -1,
            taskStartTime: null,
            isPaused: false,
            newActivity: { name: '', duration: 15 },
            // Alarm state
            departureAlarmTimeout: null,
            taskAlarmTimeouts: new Map()
        };

        // === TIME FUNCTIONS ===
        function getCurrentMinutes() {
            return state.currentTime.getHours() * 60 + state.currentTime.getMinutes();
        }

        function getDepartureMinutes() {
            const [hours, minutes] = state.departureTime.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function getAvailableMinutes() {
            return Math.max(0, getDepartureMinutes() - getCurrentMinutes());
        }

        function getPlannedMinutes() {
            return state.activities.filter(a => !a.completed).reduce((sum, a) => sum + a.duration, 0);
        }

        function getBufferMinutes() {
            return Math.max(0, getAvailableMinutes() - getPlannedMinutes());
        }

        function formatTime(minutes) {
            if (minutes < 60) return `${minutes}min`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins > 0 ? mins + 'm' : ''}`;
        }

        function formatTimeLeft(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins} Minuten`;
            return `${hours} Stunde${hours !== 1 ? 'n' : ''} ${mins > 0 ? ` und ${mins} Minuten` : ''}`;
        }

        function getBufferColor() {
            const buffer = getBufferMinutes();
            if (buffer < 10) return 'text-red-600 bg-red-50';
            if (buffer < 30) return 'text-amber-600 bg-amber-50';
            return 'text-emerald-600 bg-emerald-50';
        }

        function getTimeLeftColor() {
            const available = getAvailableMinutes();
            if (available < 30) return 'text-red-600';
            if (available < 60) return 'text-amber-600';
            return 'text-slate-600';
        }

        // === ACTIVITY TIME CALCULATION ===
        function calculateActivityFinishTimes() {
            let currentTime = new Date();
            const times = [];

            // Wenn Task l√§uft, starte von jetzt
            if (state.currentTaskIndex !== -1 && state.taskStartTime && !state.isPaused) {
                currentTime = new Date(); // Immer von jetzt starten wenn Task l√§uft
            }

            state.activities.forEach((activity, index) => {
                if (activity.completed) {
                    times.push('‚úì');
                } else if (index === state.currentTaskIndex && !state.isPaused) {
                    // Laufende Aufgabe - berechne basierend auf verbleibender Zeit
                    const timeLeft = getCurrentTaskTimeLeft();
                    if (timeLeft !== null) {
                        const finishTime = new Date(Date.now() + (timeLeft * 60000));
                        times.push(formatTimeHHMM(finishTime));
                    } else {
                        const finishTime = new Date(currentTime.getTime() + (activity.duration * 60000));
                        times.push(formatTimeHHMM(finishTime));
                        currentTime = finishTime;
                    }
                } else {
                    // Geplante Aufgabe
                    const finishTime = new Date(currentTime.getTime() + (activity.duration * 60000));
                    times.push(formatTimeHHMM(finishTime));
                    currentTime = finishTime;
                }
            });

            return times;
        }

        function formatTimeHHMM(date) {
            return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        // === TASK TIMER ===
        function getCurrentTaskTimeLeft() {
            if (state.currentTaskIndex === -1 || !state.taskStartTime || state.isPaused) return null;
            
            const currentTask = state.activities[state.currentTaskIndex];
            if (!currentTask) return null;
            
            const elapsedMinutes = Math.floor((state.currentTime - state.taskStartTime) / 60000);
            const remaining = currentTask.duration - elapsedMinutes;
            return Math.max(0, remaining);
        }

        // === ALARM SYSTEM ===
        function playAlarm() {
            console.log("üîî ALARM!");
            
            // Vibration
            if ('vibrate' in navigator) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // Audio
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                setTimeout(() => oscillator.stop(), 2000);
                
            } catch (e) {
                // Fallback
                alert('üîî ALARM!');
            }
        }

        function showNotification(message, duration = 5000) {
            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ADHS Jetzt-Planer', {
                    body: message,
                    icon: '/icon-192x192.png',
                    vibrate: [200, 100, 200]
                });
            }
            
            // Visual notification
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm text-center';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, duration);
        }

        function scheduleAlarms() {
            // Clear existing alarms
            clearAllAlarms();
            
            console.log('üîî Scheduling alarms...');
            
            // Departure alarm
            if (state.alarmEnabled) {
                scheduleDepartureAlarm();
            }
            
            // Task alarms
            scheduleTaskAlarms();
        }

        function clearAllAlarms() {
            if (state.departureAlarmTimeout) {
                clearTimeout(state.departureAlarmTimeout);
                state.departureAlarmTimeout = null;
            }
            
            state.taskAlarmTimeouts.forEach(timeout => clearTimeout(timeout));
            state.taskAlarmTimeouts.clear();
        }

        function scheduleDepartureAlarm() {
            const now = new Date();
            const [hours, minutes] = state.departureTime.split(':').map(Number);
            
            let departureDate = new Date(now);
            departureDate.setHours(hours, minutes, 0, 0);
            
            // If time passed today, schedule for tomorrow
            if (departureDate <= now) {
                departureDate.setDate(departureDate.getDate() + 1);
            }
            
            const alarmDate = new Date(departureDate.getTime() - (state.alarmMinutes * 60 * 1000));
            const timeUntilAlarm = alarmDate.getTime() - now.getTime();
            
            if (timeUntilAlarm > 0) {
                state.departureAlarmTimeout = setTimeout(() => {
                    playAlarm();
                    showNotification(`In ${state.alarmMinutes} Minuten musst du rausgehen! (${state.departureTime})`);
                }, timeUntilAlarm);
                
                console.log(`üîî Departure alarm in ${Math.round(timeUntilAlarm / 60000)} minutes`);
            }
        }

        function scheduleTaskAlarms() {
            const now = new Date();
            let currentTime = new Date(now);
            
            state.activities.forEach((activity, index) => {
                if (activity.completed) return;
                
                if (index === state.currentTaskIndex && state.taskStartTime && !state.isPaused) {
                    // Running task - alarm when time is up
                    const timeLeft = getCurrentTaskTimeLeft();
                    if (timeLeft !== null && timeLeft > 0) {
                        const timeout = setTimeout(() => {
                            playAlarm();
                            showNotification(`Zeit abgelaufen: ${activity.name}`);
                            
                            // Auto complete task
                            setTimeout(() => {
                                if (!activity.completed) {
                                    toggleActivity(activity.id);
                                }
                            }, 2000);
                        }, timeLeft * 60000);
                        
                        state.taskAlarmTimeouts.set(activity.id, timeout);
                        console.log(`üîî Task alarm for "${activity.name}" in ${timeLeft} minutes`);
                    }
                } else {
                    // Future task - calculate when it would finish
                    const finishTime = new Date(currentTime.getTime() + (activity.duration * 60000));
                    currentTime = finishTime;
                    
                    const timeUntilFinish = finishTime.getTime() - now.getTime();
                    if (timeUntilFinish > 0) {
                        const timeout = setTimeout(() => {
                            playAlarm();
                            showNotification(`Zeit f√ºr: ${activity.name}`);
                        }, timeUntilFinish);
                        
                        state.taskAlarmTimeouts.set(activity.id, timeout);
                        console.log(`üîî Future task "${activity.name}" finishes in ${Math.round(timeUntilFinish / 60000)} minutes`);
                    }
                }
            });
        }

        // === EVENT HANDLERS ===
        function addActivity() {
            if (!state.newActivity.name.trim()) return;
            
            const activity = {
                id: Date.now(),
                name: state.newActivity.name.trim(),
                duration: parseInt(state.newActivity.duration),
                completed: false
            };
            
            state.activities.push(activity);
            state.newActivity = { name: '', duration: 15 };
            state.showAddForm = false;
            
            saveState();
            render();
            scheduleAlarms();
        }

        function toggleActivity(id) {
            const activity = state.activities.find(a => a.id === id);
            if (activity) {
                activity.completed = !activity.completed;
                
                // If we completed the current task, move to next
                if (activity.completed && state.currentTaskIndex !== -1 && 
                    state.activities[state.currentTaskIndex].id === id) {
                    
                    state.currentTaskIndex = -1;
                    state.taskStartTime = null;
                    state.isPaused = false;
                    
                    // Auto start next task
                    const nextIndex = state.activities.findIndex(a => !a.completed);
                    if (nextIndex !== -1) {
                        setTimeout(() => startTask(nextIndex), 1000);
                    }
                }
                
                saveState();
                render();
                scheduleAlarms();
            }
        }

        function deleteActivity(id) {
            const index = state.activities.findIndex(a => a.id === id);
            if (index !== -1) {
                // If deleting current task, reset
                if (index === state.currentTaskIndex) {
                    state.currentTaskIndex = -1;
                    state.taskStartTime = null;
                    state.isPaused = false;
                }
                
                state.activities.splice(index, 1);
                
                // Adjust current task index
                if (state.currentTaskIndex > index) {
                    state.currentTaskIndex--;
                }
                
                saveState();
                render();
                scheduleAlarms();
            }
        }

        function clearAll() {
            if (confirm('Alle Aktivit√§ten l√∂schen?')) {
                state.activities = [];
                state.currentTaskIndex = -1;
                state.taskStartTime = null;
                state.isPaused = false;
                
                saveState();
                render();
                scheduleAlarms();
            }
        }

        function startTask(index) {
            state.currentTaskIndex = index;
            state.taskStartTime = new Date();
            state.isPaused = false;
            
            saveState();
            render();
            scheduleAlarms();
        }

        function pauseResumeTask() {
            if (state.currentTaskIndex !== -1) {
                state.isPaused = !state.isPaused;
                
                // Adjust start time when resuming
                if (!state.isPaused && state.taskStartTime) {
                    const pausedDuration = Date.now() - state.taskStartTime.getTime();
                    // Don't adjust - keep original start time for simplicity
                }
                
                render();
                scheduleAlarms();
            }
        }

        function completeCurrentTask() {
            if (state.currentTaskIndex !== -1) {
                const currentActivity = state.activities[state.currentTaskIndex];
                if (currentActivity) {
                    toggleActivity(currentActivity.id);
                }
            }
        }

        function startNextTask() {
            const nextIndex = state.activities.findIndex(a => !a.completed);
            if (nextIndex !== -1) {
                startTask(nextIndex);
            }
        }

        // Form handlers
        function toggleAddForm() {
            state.showAddForm = !state.showAddForm;
            render();
        }

        function cancelAddForm() {
            state.showAddForm = false;
            state.newActivity = { name: '', duration: 15 };
            render();
        }

        function toggleSettings() {
            state.showSettings = !state.showSettings;
            render();
        }

        function updateActivityName(value) {
            state.newActivity.name = value;
        }

        function updateActivityDuration(value) {
            state.newActivity.duration = value;
        }

        function updateDepartureTime(value) {
            state.departureTime = value;
            saveState();
            scheduleAlarms();
        }

        function updateAlarmMinutes(value) {
            state.alarmMinutes = parseInt(value);
            saveState();
            scheduleAlarms();
        }

        function toggleAlarm() {
            state.alarmEnabled = !state.alarmEnabled;
            saveState();
            scheduleAlarms();
            render();
        }

        function testAlarm() {
            playAlarm();
            showNotification('üîî Test-Alarm! So klingt der echte Alarm.', 3000);
        }

        // === RENDER ===
        function render() {
            const app = document.getElementById('app');
            const timeLeft = getCurrentTaskTimeLeft();
            const activityTimes = calculateActivityFinishTimes();
            
            app.innerHTML = `
                <!-- Header -->
                <header class="glass-effect border-b border-white/30 sticky top-0 z-50">
                    <div class="max-w-4xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="p-2 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl text-white">
                                    <i data-lucide="brain" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h1 class="text-xl font-bold text-slate-800">ADHS Jetzt-Planer</h1>
                                    <p class="text-sm text-slate-500">Fokussiert und organisiert</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-mono font-bold text-slate-800">
                                    ${state.currentTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                <div class="text-sm text-slate-500">
                                    ${state.currentTime.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' })}
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
                    <!-- Zeit-√úbersicht -->
                    <div class="glass-effect rounded-3xl p-6 shadow-lg border border-white/50">
                        <div class="text-center mb-6">
                            <h2 class="text-4xl font-bold mb-2 ${getTimeLeftColor()}">
                                ${getAvailableMinutes() > 0 ? formatTimeLeft(getAvailableMinutes()) : 'Zeit zum Gehen!'}
                            </h2>
                            <p class="text-slate-600">bis du um ${state.departureTime} rausmusst</p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-2xl">
                                <div class="text-2xl font-bold text-blue-600">${formatTime(getAvailableMinutes())}</div>
                                <div class="text-sm text-blue-600">Verf√ºgbar</div>
                            </div>
                            <div class="text-center p-4 bg-indigo-50 rounded-2xl">
                                <div class="text-2xl font-bold text-indigo-600">${formatTime(getPlannedMinutes())}</div>
                                <div class="text-sm text-indigo-600">Geplant</div>
                            </div>
                            <div class="text-center p-4 rounded-2xl ${getBufferColor()}">
                                <div class="text-2xl font-bold">${formatTime(getBufferMinutes())}</div>
                                <div class="text-sm">Puffer</div>
                            </div>
                        </div>
                    </div>

                    <!-- Aktuelle Aufgabe -->
                    ${state.currentTaskIndex !== -1 && state.activities[state.currentTaskIndex] ? `
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-3xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="target" class="w-6 h-6"></i>
                                    <h3 class="font-semibold">Aktuelle Aufgabe</h3>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="pauseResumeTask()" class="p-2 bg-white/20 hover:bg-white/30 rounded-xl transition-colors">
                                        <i data-lucide="${state.isPaused ? 'play' : 'pause'}" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="completeCurrentTask()" class="p-2 bg-white/20 hover:bg-white/30 rounded-xl transition-colors">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xl font-bold">${state.activities[state.currentTaskIndex].name}</div>
                                    <div class="text-emerald-100">
                                        ${state.activities[state.currentTaskIndex].duration} Minuten eingeplant
                                    </div>
                                </div>
                                ${timeLeft !== null ? `
                                    <div class="text-right">
                                        <div class="text-3xl font-mono font-bold">
                                            ${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}
                                        </div>
                                        <div class="text-emerald-100">verbleibend</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${state.isPaused ? `
                                <div class="mt-3 text-center text-emerald-100 font-medium">
                                    ‚è∏Ô∏è Pausiert
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Aktivit√§ten -->
                    <div class="glass-effect rounded-3xl shadow-lg border border-white/50 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-bold text-slate-800 flex items-center">
                                    <i data-lucide="calendar" class="w-5 h-5 mr-2 text-blue-500"></i>
                                    Meine Aufgaben
                                </h2>
                                <div class="flex items-center space-x-2">
                                    <button onclick="toggleAddForm()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center space-x-2 transition-colors">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        <span>Neu</span>
                                    </button>
                                    ${state.activities.length > 0 ? `
                                        <button onclick="clearAll()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl flex items-center space-x-2 transition-colors">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    ` : ''}
                                    <button onclick="toggleSettings()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 p-2 rounded-xl transition-colors">
                                        <i data-lucide="settings" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Add Form -->
                        ${state.showAddForm ? `
                            <div class="p-6 bg-blue-50 border-b border-slate-100">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">
                                            Was m√∂chtest du tun?
                                        </label>
                                        <input
                                            type="text"
                                            id="activity-name"
                                            value="${state.newActivity.name}"
                                            placeholder="z.B. E-Mails checken"
                                            autocomplete="off"
                                            oninput="updateActivityName(this.value)"
                                            onkeydown="if(event.key==='Enter') addActivity()"
                                            class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">
                                            Wie lange? (Minuten)
                                        </label>
                                        <input
                                            type="number"
                                            id="activity-duration"
                                            value="${state.newActivity.duration}"
                                            min="1"
                                            max="180"
                                            oninput="updateActivityDuration(this.value)"
                                            onkeydown="if(event.key==='Enter') addActivity()"
                                            class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    <div class="flex space-x-3">
                                        <button onclick="addActivity()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-medium">
                                            Hinzuf√ºgen
                                        </button>
                                        <button onclick="cancelAddForm()" class="px-6 bg-slate-100 hover:bg-slate-200 text-slate-600 py-3 rounded-xl font-medium">
                                            Abbrechen
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Settings -->
                        ${state.showSettings ? `
                            <div class="p-6 bg-slate-50 border-b border-slate-100">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">
                                            Wann musst du raus?
                                        </label>
                                        <input
                                            type="time"
                                            value="${state.departureTime}"
                                            onchange="updateDepartureTime(this.value)"
                                            class="px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-slate-700">Alarm aktiviert</span>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="toggleAlarm()" class="p-2 rounded-xl transition-colors ${state.alarmEnabled ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-400'}">
                                                <i data-lucide="${state.alarmEnabled ? 'bell' : 'bell-off'}" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="testAlarm()" class="p-2 rounded-xl bg-red-500 text-white hover:bg-red-600" title="Test">
                                                <i data-lucide="volume-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${state.alarmEnabled ? `
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">
                                                Alarm-Vorlaufzeit
                                            </label>
                                            <select onchange="updateAlarmMinutes(this.value)" class="px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="5" ${state.alarmMinutes === 5 ? 'selected' : ''}>5 Minuten</option>
                                                <option value="10" ${state.alarmMinutes === 10 ? 'selected' : ''}>10 Minuten</option>
                                                <option value="15" ${state.alarmMinutes === 15 ? 'selected' : ''}>15 Minuten</option>
                                                <option value="30" ${state.alarmMinutes === 30 ? 'selected' : ''}>30 Minuten</option>
                                            </select>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Activity List -->
                        <div class="p-6">
                            ${state.activities.length === 0 ? `
                                <div class="text-center py-12">
                                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i data-lucide="target" class="w-8 h-8 text-slate-400"></i>
                                    </div>
                                    <p class="text-slate-500 text-lg">Noch keine Aufgaben geplant</p>
                                    <p class="text-slate-400">F√ºge deine erste Aufgabe hinzu!</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${state.activities.map((activity, index) => `
                                        <div class="flex items-center p-4 rounded-2xl transition-all ${
                                            activity.completed
                                                ? 'bg-emerald-50 border border-emerald-200'
                                                : state.currentTaskIndex === index
                                                ? 'bg-blue-50 current-task-border'
                                                : 'bg-slate-50 border border-slate-200 hover:bg-slate-100'
                                        }">
                                            <button onclick="toggleActivity(${activity.id})" class="mr-4 p-1 rounded-full transition-colors ${
                                                activity.completed ? 'text-emerald-500' : 'text-slate-400 hover:text-blue-500'
                                            }">
                                                <i data-lucide="${activity.completed ? 'check-circle' : 'circle'}" class="w-6 h-6"></i>
                                            </button>
                                            
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between mb-1">
                                                    <div class="font-medium ${
                                                        activity.completed ? 'text-emerald-700 line-through' : 'text-slate-800'
                                                    }">
                                                        ${activity.name}
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="font-mono font-bold text-lg ${
                                                            activity.completed ? 'text-emerald-600' : 
                                                            state.currentTaskIndex === index ? 'text-blue-600' : 'text-slate-700'
                                                        }">
                                                            ${activityTimes[index] || '--:--'}
                                                        </div>
                                                        <div class="text-xs ${
                                                            activity.completed ? 'text-emerald-500' : 
                                                            state.currentTaskIndex === index ? 'text-blue-500' : 'text-slate-500'
                                                        }">
                                                            ${activity.completed ? 'Erledigt' : 
                                                              state.currentTaskIndex === index ? 'L√§uft bis' : 'Fertig um'}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="text-sm text-slate-500">
                                                    ${activity.duration} Minuten
                                                    ${state.currentTaskIndex === index && !state.isPaused ? 
                                                        '<span class="ml-2 text-blue-600 font-medium">‚Ä¢ L√§uft</span>' : ''}
                                                    ${state.currentTaskIndex === index && state.isPaused ? 
                                                        '<span class="ml-2 text-amber-600 font-medium">‚Ä¢ Pausiert</span>' : ''}
                                                </div>
                                            </div>

                                            <div class="flex items-center space-x-2 ml-3">
                                                ${!activity.completed && state.currentTaskIndex !== index ? `
                                                    <button onclick="startTask(${index})" class="p-2 text-blue-500 hover:bg-blue-100 rounded-xl transition-colors" title="Starten">
                                                        <i data-lucide="play" class="w-4 h-4"></i>
                                                    </button>
                                                ` : ''}
                                                
                                                <button onclick="deleteActivity(${activity.id})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    
                                    ${state.activities.filter(a => !a.completed).length > 0 && state.currentTaskIndex === -1 ? `
                                        <button onclick="startNextTask()" class="w-full mt-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-4 rounded-2xl font-medium hover:shadow-lg transition-all flex items-center justify-center space-x-2">
                                            <i data-lucide="play" class="w-5 h-5"></i>
                                            <span>Erste Aufgabe starten</span>
                                        </button>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    </div>
                </main>
            `;
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // === STORAGE ===
        function saveState() {
            try {
                const stateToSave = { ...state };
                delete stateToSave.currentTime;
                delete stateToSave.departureAlarmTimeout;
                delete stateToSave.taskAlarmTimeouts;
                localStorage.setItem('adhs-planer-state', JSON.stringify(stateToSave));
            } catch (e) {
                console.warn('Could not save state');
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('adhs-planer-state');
                if (saved) {
                    const parsedState = JSON.parse(saved);
                    state = { ...state, ...parsedState };
                    
                    if (state.taskStartTime) {
                        state.taskStartTime = new Date(state.taskStartTime);
                    }
                    
                    // Reset alarm timeouts (will be recreated)
                    state.departureAlarmTimeout = null;
                    state.taskAlarmTimeouts = new Map();
                }
            } catch (e) {
                console.warn('Could not load state');
            }
        }

        // === INIT ===
        async function init() {
            loadState();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Update time every second
            setInterval(() => {
                state.currentTime = new Date();
                
                // Only re-render if not typing
                const activeElement = document.activeElement;
                const isTyping = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.tagName === 'SELECT'
                );
                
                if (!isTyping) {
                    render();
                }
            }, 1000);
            
            render();
            
            // Schedule alarms after first render
            setTimeout(() => {
                scheduleAlarms();
            }, 1000);
        }

        // Start app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
